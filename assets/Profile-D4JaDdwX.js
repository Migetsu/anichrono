import{A as e,C as t,D as n,E as r,F as i,I as a,M as o,N as s,O as c,S as l,T as u,_ as d,b as f,g as ee,h as p,i as te,j as m,k as h,m as g,n as ne,p as _,r as re,t as ie,u as ae,v,w as y,y as b}from"./index-5GYE3_r7.js";import{n as oe,t as se}from"./searchAnimeById-BWUfyleL.js";var ce={class:`profile`},le={class:`profile-container`},ue={class:`profile-header`},de={class:`profile-header__avatar-section`},fe=[`src`],pe={class:`profile-header__info`},me={class:`profile-header__nickname`},he={class:`profile-header__meta`},ge={class:`profile-meta-item`},_e={key:0,class:`profile-meta-item`},ve={class:`profile-header__actions`},ye={class:`profile-stats`},be={class:`stat-card`},xe={class:`stat-card__value`},Se={class:`stat-card`},Ce={class:`stat-card__value`},we={class:`stat-card`},Te={class:`stat-card__value`},Ee={class:`stat-card`},De={class:`stat-card__value`},Oe={key:0,class:`profile-section history-section`},ke={class:`history-list`},Ae={class:`history-item__content`},je={class:`history-item__meta`},Me={class:`history-item__action`},Ne={class:`history-item__date`},Pe={class:`profile-section activity-section`},Fe={class:`section-title`},Ie={class:`activity-stats`},Le={class:`activity-item`},Re={class:`activity-info`},ze={class:`activity-value`},Be={class:`activity-item`},Ve={class:`activity-info`},He={class:`activity-value`},Ue={class:`profile-section lists-section`},We={class:`lists-header`},Ge={class:`section-title`},Ke={class:`search-box`},qe=[`placeholder`],Je={class:`lists-tabs`},Ye=[`onClick`],Xe={class:`tab-count`},Ze={class:`lists-content`},Qe={key:0,class:`lists-loading`},$e={key:1,class:`lists-error`},et={key:2,class:`anime-grid`},tt={class:`anime-card__content`},nt={class:`anime-card__title`},rt={key:0,class:`anime-card__meta`},it={key:1,class:`empty-state`},at={key:0},ot={key:1},x=`anichrono_anime_cache`,S=1440*60*1e3,C=ne({__name:`Profile`,setup(ne){let C=re(),w=te(),T=m(`watching`),E=m(``);async function D(e=!1){if(!(!C?.token||!C?.user?.id)&&!w.loading&&(e||!w.rates.length))try{await w.fetchRates()}catch{}}l(()=>{D(!0),A(),st()});function st(){let e=U();e&&Object.keys(e).forEach(t=>{let n=e[t];if(n&&!I[t]){I[t]=n,V[t]=`loaded`;let e=G(n);e&&(F[t]=e)}})}n(()=>[C?.token,C?.user?.id],()=>{D(!0),A()}),t(()=>{Q&&clearTimeout(Q)});function O(e){return e?e.startsWith(`//`)?`https:${e}`:/^https?:\/\//i.test(e)?e:`https://shikimori.one${e}`:``}function ct(e){return e?[e.poster?.originalUrl,e.poster?.previewUrl,e.image?.original,e.image?.preview,e.image?.x256,e.image?.x192,e.image?.x96,e.image?.x48].filter(Boolean).map(O):[]}let lt=g(()=>{let e=C?.user??{},t=[e.image?.x160,e.image?.x148,e.avatar,e.avatar_url,e.image?.x80,e.profile?.avatar,e.image?.x48];for(let e of t)if(e)return O(e);return`/avatar.svg`}),ut=g(()=>C?.user?.nickname||C?.user?.name||C?.user?.login||`—`);function dt(){C.logout()}function ft(){C?.user?.id&&window.open(`https://shikimori.one/${C.user.nickname}`,`_blank`)}let pt=g(()=>{let e=C?.user;if(!e)return`—`;if(e.common_info&&Array.isArray(e.common_info)){for(let t of e.common_info)if(t&&t[0]&&typeof t[0]==`string`&&t[0].toLowerCase().includes(`сайте`))return t[1]||t[0]}if(e.created_at){let t=new Date(e.created_at);if(!isNaN(t.getTime())){let e=t.toLocaleDateString(`ru-RU`,{month:`long`}),n=t.getFullYear();return`с ${e} ${n} г.`}}return e.website&&typeof e.website==`string`&&e.website.includes(`сайте`)?e.website:(console.log(`❌ Дата регистрации не найдена!`),`неизвестно`)}),mt=g(()=>{let e=C?.user;if(!e)return`—`;let t=e.last_online_at||e.last_online||e.stats?.time_online;if(!t){if(e.common_info&&Array.isArray(e.common_info)){let t=e.common_info.find(e=>e.name&&(e.name.includes(`Время`)||e.name.includes(`время`)));if(t&&t.value)return t.value}return`—`}if(typeof t==`number`){if(t<1e3)return`${t} ч`;let e=new Date(t),n=new Date,r=Math.floor((n-e)/1e3/60/60);return r<1?`менее часа назад`:r<24?`${r} ч назад`:`${Math.floor(r/24)} дн назад`}if(typeof t==`string`){if(t.match(/\d+\s*(час|ч|дн|день|день|минут)/i))return t;let e=new Date(t);if(!isNaN(e.getTime())){let t=new Date,n=Math.floor((t-e)/1e3/60/60);return n<1?`менее часа назад`:n<24?`${n} ч назад`:`${Math.floor(n/24)} дн назад`}}return`—`}),ht=g(()=>w.rates.length||0),k=m([]);async function A(){if(C?.user?.id)try{let e=await fetch(`/api/user-history?user_id=${C.user.id}&limit=3`);e.ok&&(k.value=(await e.json()).map(e=>({anime_id:e.target?.id||0,anime_title:e.target?.russian||e.target?.name||`Аниме #${e.target?.id}`,action:e.description||``,status:gt(e.description),date:e.created_at})))}catch(e){console.error(`Ошибка загрузки истории:`,e)}}function gt(e){if(!e)return``;for(let[t,n]of Object.entries({Запланировано:`planned`,Смотрю:`watching`,Просмотрено:`completed`,Отложено:`on_hold`,Брошено:`dropped`,Пересматриваю:`rewatching`}))if(e.includes(t))return t;return e}function _t(e){return e.includes(`Добавлено`)||e.includes(`добавлен`)?`fa-solid fa-plus`:e.includes(`Удалено`)||e.includes(`удален`)?`fa-solid fa-trash`:e.includes(`Изменено`)||e.includes(`изменен`)?`fa-solid fa-pen`:`fa-solid fa-clock`}function vt(e){return e.includes(`Добавлено`)||e.includes(`добавлен`)?`action-add`:e.includes(`Удалено`)||e.includes(`удален`)?`action-remove`:`action-change`}function yt(e,t){return e||t||`Изменение в списке`}function bt(e){if(!e)return``;let t=new Date(e),n=new Date,r=Math.floor((n-t)/1e3);return r<60?`только что`:r<3600?`${Math.floor(r/60)} мин назад`:r<86400?`${Math.floor(r/3600)} ч назад`:r<604800?`${Math.floor(r/86400)} дн назад`:t.toLocaleDateString(`ru-RU`,{day:`numeric`,month:`short`})}let xt=g(()=>{let e=w.rates.length;if(e===0)return`0 часов`;let t=Math.round(e*12*24/60);if(t<24)return`${t} ч`;let n=Math.floor(t/24),r=t%24;return r>0?`${n} дн ${r} ч`:`${n} дней`}),j=g(()=>({planned:w.grouped?.planned??[],watching:w.grouped?.watching??[],rewatching:w.grouped?.rewatching??[],completed:w.grouped?.completed??[],on_hold:w.grouped?.on_hold??[],dropped:w.grouped?.dropped??[]})),St=g(()=>{let e=P.find(e=>e.key===T.value);return e?e.title:`списке`}),M=g(()=>{let e=j.value[T.value]||[];if(!E.value.trim())return e;let t=E.value.toLowerCase().trim();return e.filter(e=>Y(e).toLowerCase().includes(t))}),Ct=g(()=>w.loading),N=g(()=>w.error),P=[{key:`planned`,title:`Запланировано`},{key:`watching`,title:`Смотрю`},{key:`rewatching`,title:`Пересматриваю`},{key:`completed`,title:`Просмотрено`},{key:`on_hold`,title:`Отложено`},{key:`dropped`,title:`Брошено`}],F=e({}),I=e({}),L=e(new Set),R=e({}),z=e({}),B=e(new Set),V=e({});function H(e){try{let t={timestamp:Date.now(),data:e};localStorage.setItem(x,JSON.stringify(t))}catch(e){console.warn(`Не удалось сохранить в локальный кэш:`,e)}}function U(){try{let e=localStorage.getItem(x);if(!e)return null;let t=JSON.parse(e);return Date.now()-t.timestamp>S?(localStorage.removeItem(x),null):t.data}catch(e){return console.warn(`Не удалось загрузить из локального кэша:`,e),null}}function W(e){return Number(e?.target_id??e?.targetId??e?.target?.id??e?.anime?.id)}function G(e){return[...ct(e),e?.image&&O(e.image.original),e?.image&&O(e.image.preview)].filter(Boolean)[0]||``}function wt(e){return new Promise(t=>{let n=new Image;n.onload=()=>t(!0),n.onerror=()=>t(!1),n.src=e})}async function K(e){if(!e||B.has(e))return!0;try{let t=await wt(e);return t&&B.add(e),t}catch{return!1}}async function Tt(e){let t=e.filter(e=>e&&!B.has(e));if(t.length===0)return;let n=[];for(let e=0;e<t.length;e+=3)n.push(t.slice(e,e+3));for(let e of n)await Promise.all(e.map(e=>K(e))),n.indexOf(e)<n.length-1&&await new Promise(e=>setTimeout(e,100))}async function q(e,t=0){let n=W(e);if(!Number.isFinite(n)||n<=0||I[n]&&(I[n].russian||I[n].name)||L.has(n))return;if((R[n]||0)>=4){I[n]||(I[n]={id:n,name:`Аниме #${n}`,russian:null});return}let r=U();if(r&&r[n]){I[n]=r[n],V[n]=`loaded`;let e=G(r[n]);e&&(F[n]=e,K(e).catch(()=>{}));return}L.add(n),z[n]=Date.now(),V[n]=`loading`;try{let e=await se(n);if(e&&(e.russian||e.name)){I[n]=e,R[n]=0,V[n]=`loaded`;let t=U()||{};t[n]=e,H(t);let r=G(e);r?(F[n]=r,K(r).catch(()=>{})):F[n]=null}else throw Error(`No title data`)}catch(r){if(console.warn(`Попытка ${t+1}/4 загрузки аниме ${n} не удалась:`,r.message),R[n]=(R[n]||0)+1,R[n]<4){let r=Math.min(1e3*2**R[n],5e3);setTimeout(()=>{L.delete(n),q(e,t+1)},r)}else V[n]=`error`,F[n]=null,I[n]||(I[n]={id:n,name:`Аниме #${n}`,russian:null}),L.delete(n)}finally{((R[n]||0)>=4||I[n])&&L.delete(n)}}async function J(e,t=1){let n=e.map(e=>W(e)).filter(e=>Number.isFinite(e)&&e>0&&!I[e]&&!L.has(e));if(n.length===0)return;let r=[];for(let t of e){let e=W(t);I[e]&&F[e]&&r.push(F[e])}if(r.length>0&&Tt(r).catch(()=>{}),n.length>=3)try{let t=await oe(n.slice(0,5));t.forEach(e=>{if(e&&e.id){I[e.id]=e,V[e.id]=`loaded`;let t=G(e);t&&(F[e.id]=t,K(t).catch(()=>{}));let n=U()||{};n[e.id]=e,H(n)}});let r=new Set(t.map(e=>e.id)),i=n.filter(e=>!r.has(e));for(let t of i){let n=e.find(e=>W(e)===t);n&&(await q(n),await new Promise(e=>setTimeout(e,2e3)))}return}catch(e){console.warn(`Batch загрузка не удалась, переходим к индивидуальной:`,e)}for(let t of e){let e=W(t);Number.isFinite(e)&&e>0&&!I[e]&&!L.has(e)&&(await q(t),await new Promise(e=>setTimeout(e,2e3)))}}function Et(e){let t=W(e),n=F[t];return n?{backgroundImage:`url(${n})`,backgroundColor:`#1a1a2e`}:{background:`linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)`,backgroundColor:`#1a1a2e`}}function Y(e){let t=W(e);if(e.anime?.russian)return e.anime.russian;if(e.anime?.name)return e.anime.name;if(e.target?.russian)return e.target.russian;if(e.target?.name)return e.target.name;if(I[t]){let e=I[t];if(e?.russian)return e.russian;if(e?.name)return e.name}return Number.isFinite(t)&&t>0?!I[t]&&!L.has(t)?(q(e),`Аниме #${t}`):(L.has(t),`Аниме #${t}`):`Неизвестное аниме`}n(()=>T.value,async e=>{if(E.value=``,j.value[e]&&j.value[e].length>0){let t=j.value[e].slice(0,15);await J(t,1)}},{immediate:!1});async function Dt(){let e=T.value;if(j.value[e]&&j.value[e].length>0){let t=Math.min(j.value[e].length,8),n=j.value[e].slice(0,t);await J(n,1)}}n(()=>w.rates.length,e=>{e&&setTimeout(Dt,100)},{immediate:!0});let X=null;l(()=>{X=setInterval(()=>{let e=Object.keys(R);for(let t of e){let e=Number(t);if(!Number.isFinite(e)||I[e]||L.has(e))continue;let n=R[e]||0;if(n>=2)continue;let r=z[e]||0,i=Math.min(3e4*(n+1),6e4);Date.now()-r>=i&&q({anime:{id:e}})}},3e4)}),t(()=>{X&&clearInterval(X)});let Z=e(new Set),Q=null,$=new IntersectionObserver(e=>{for(let t of e){if(!t.isIntersecting)continue;let e=t.target.__rate;e&&(Z.add(e),$.unobserve(t.target))}Q&&clearTimeout(Q),Q=setTimeout(()=>{if(Z.size>0){let e=Array.from(Z).slice(0,1);Z.clear(),J(e,1)}},1e3)},{root:null,rootMargin:`300px 0px 300px 0px`,threshold:0}),Ot={mounted(e,t){e.__rate=t.value,$.observe(e)},updated(e,t){e.__rate=t.value},unmounted(e){$.unobserve(e),delete e.__rate}};return(e,t)=>{let n=r(`font-awesome-icon`),l=r(`RouterLink`);return y(),v(_,null,[p(`main`,ce,[p(`div`,le,[p(`header`,ue,[p(`div`,de,[p(`img`,{class:`profile-header__avatar`,src:lt.value,alt:`avatar`},null,8,fe),t[2]||=p(`div`,{class:`profile-header__status`},`в сети`,-1)]),p(`div`,pe,[p(`h1`,me,a(ut.value),1),p(`div`,he,[p(`div`,ge,[f(n,{icon:`fa-regular fa-calendar`}),p(`span`,null,`На сайте с `+a(pt.value),1)]),o(C)?.user?.email?(y(),v(`div`,_e,[f(n,{icon:`fa-regular fa-envelope`}),p(`span`,null,a(o(C).user.email),1)])):d(``,!0)]),p(`div`,ve,[p(`button`,{class:`btn btn-shikimori`,onClick:ft},[f(n,{icon:`fa-solid fa-external-link-alt`}),t[3]||=b(` Профиль шикимори `,-1)]),p(`button`,{class:`btn btn-logout`,onClick:dt},[f(n,{icon:`fa-solid fa-right-from-bracket`}),t[4]||=b(` Выйти `,-1)])])])]),p(`div`,ye,[p(`div`,be,[p(`div`,xe,a(ht.value),1),t[5]||=p(`div`,{class:`stat-card__label`},`Всего аниме`,-1)]),p(`div`,Se,[p(`div`,Ce,a(j.value.watching.length),1),t[6]||=p(`div`,{class:`stat-card__label`},`Смотрю`,-1)]),p(`div`,we,[p(`div`,Te,a(j.value.completed.length),1),t[7]||=p(`div`,{class:`stat-card__label`},`Просмотрено`,-1)]),p(`div`,Ee,[p(`div`,De,a(j.value.planned.length),1),t[8]||=p(`div`,{class:`stat-card__label`},`Запланировано`,-1)])]),k.value.length?(y(),v(`section`,Oe,[f(l,{to:`/history`,class:`section-title section-title--link`},{default:c(()=>[f(n,{icon:`fa-solid fa-clock-rotate-left`}),t[9]||=b(` История `,-1),f(n,{icon:`fa-solid fa-chevron-right`,class:`section-title__arrow`})]),_:1}),p(`div`,ke,[(y(!0),v(_,null,u(k.value.slice(0,3),(e,t)=>(y(),v(`div`,{key:t,class:`history-item`},[p(`div`,{class:s([`history-item__icon`,vt(e.action)])},[f(n,{icon:_t(e.action)},null,8,[`icon`])],2),p(`div`,Ae,[f(l,{to:`/animes/${e.anime_id}`,class:`history-item__title`},{default:c(()=>[b(a(e.anime_title),1)]),_:2},1032,[`to`]),p(`div`,je,[p(`span`,Me,a(yt(e.action,e.status)),1),p(`span`,Ne,a(bt(e.date)),1)])])]))),128))])])):d(``,!0),p(`section`,Pe,[p(`h2`,Fe,[f(n,{icon:`fa-solid fa-chart-line`}),t[10]||=b(` Активность `,-1)]),p(`div`,Ie,[p(`div`,Le,[f(n,{icon:`fa-solid fa-clock`,class:`activity-icon`}),p(`div`,Re,[p(`div`,ze,a(mt.value),1),t[11]||=p(`div`,{class:`activity-label`},`Последняя активность`,-1)])]),p(`div`,Be,[f(n,{icon:`fa-solid fa-eye`,class:`activity-icon`}),p(`div`,Ve,[p(`div`,He,a(xt.value),1),t[12]||=p(`div`,{class:`activity-label`},`Времени за просмотром`,-1)])])])]),p(`section`,Ue,[p(`div`,We,[p(`h2`,Ge,[f(n,{icon:`fa-solid fa-list`}),t[13]||=b(` Списки аниме `,-1)]),p(`div`,Ke,[f(n,{icon:`fa-solid fa-search`,class:`search-box__icon`}),h(p(`input`,{"onUpdate:modelValue":t[0]||=e=>E.value=e,type:`text`,class:`search-box__input`,placeholder:`Поиск в ${St.value}...`},null,8,qe),[[ae,E.value]]),E.value?(y(),v(`button`,{key:0,onClick:t[1]||=e=>E.value=``,class:`search-box__clear`},[f(n,{icon:`fa-solid fa-times`})])):d(``,!0)])]),p(`div`,Je,[(y(),v(_,null,u(P,e=>p(`button`,{key:e.key,class:s([`tab-btn`,{active:T.value===e.key}]),onClick:t=>T.value=e.key},[b(a(e.title)+` `,1),p(`span`,Xe,a(j.value[e.key].length),1)],10,Ye)),64))]),p(`div`,Ze,[Ct.value?(y(),v(`div`,Qe,[f(n,{icon:`fa-solid fa-spinner`,spin:``}),t[14]||=b(` Загрузка... `,-1)])):N.value?(y(),v(`div`,$e,a(N.value),1)):(y(),v(`div`,et,[M.value.length>0?(y(!0),v(_,{key:0},u(M.value,e=>h((y(),ee(l,{key:e.id||e.target_id,to:`/animes/${W(e)}`,class:`anime-card`},{default:c(()=>[p(`div`,{class:`anime-card__image`,style:i(Et(e))},null,4),t[15]||=p(`div`,{class:`anime-card__overlay`},null,-1),p(`div`,tt,[p(`div`,nt,a(Y(e)),1),e.score?(y(),v(`div`,rt,[f(n,{icon:`fa-solid fa-star`}),b(` `+a(e.score),1)])):d(``,!0)])]),_:2},1032,[`to`])),[[Ot,e]])),128)):(y(),v(`div`,it,[f(n,{icon:E.value?`fa-solid fa-search`:`fa-regular fa-folder-open`},null,8,[`icon`]),E.value?(y(),v(`p`,at,` Ничего не найдено по запросу "`+a(E.value)+`" `,1)):(y(),v(`p`,ot,`Список пуст`))]))]))])])])]),f(ie)],64)}}},[[`__scopeId`,`data-v-58dfea4c`]]);export{C as default};