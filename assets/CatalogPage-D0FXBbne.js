import{D as e,E as t,F as n,I as r,M as i,N as a,O as o,S as s,T as c,_ as l,a as u,b as d,c as f,d as ee,g as te,h as p,j as m,k as h,l as ne,m as g,n as _,o as v,p as y,t as re,u as ie,v as b,w as x,y as S}from"./index-5GYE3_r7.js";var C=new Set([`popularity`,`ranked`,`aired_on`]);async function ae({page:e=1,limit:t=20,search:n=``,status:r=null,order:i=`popularity`}={}){let a=`
    query ($page: Int, $limit: Int, $search: String, $status: AnimeStatusString) {
      animes(page: $page, limit: $limit, search: $search, status: $status, order: ${C.has(i)?i:`popularity`}) {
        id
        name
        russian
        score
        status
        poster { originalUrl }
        genres { id name russian }
        airedOn { year month }
      }
    }
  `,o=new Set,s=String(n||``);o.add(s),s&&((s.includes(`е`)||s.includes(`Е`))&&o.add(s.replace(/е/g,`ё`).replace(/Е/g,`Ё`)),(s.includes(`ё`)||s.includes(`Ё`))&&o.add(s.replace(/ё/g,`е`).replace(/Ё/g,`Е`)));let c=Array.from(o).map(n=>u(a,{page:e,limit:t,search:n||null,status:r||null}).then(e=>Array.isArray(e?.animes)?e.animes:[]).catch(()=>[])),l=await Promise.all(c),d=new Set,f=[];for(let e of l)for(let t of e){if(!t||d.has(t.id))continue;d.add(t.id),f.push(t)}return f}var oe={class:`CatalogPage`},se={class:`container`},ce={class:`content-grid`},le={class:`content-left`},ue={class:`toolbar`},de={class:`found`},fe={class:`sort`},pe={class:`row row-search`},me={class:`search`},he={class:`row grid grid-filters`},ge={class:`checks`},_e=[`value`],w={class:`sort-list`},T=[`onClick`],E={class:`actions`},D={class:`grid-cards`},O={class:`catalog-card__top`},k={key:0,class:`status-badge status-badge--green`},A={key:1,class:`status-badge status-badge--gold`},j={class:`catalog-card__content`},M=[`title`],N={class:`catalog-card__meta`},P={class:`meta-rating`},F={class:`meta-year`},I={key:0,class:`catalog-card__genres`},L={key:0,class:`load-state`},ve={key:1,class:`load-state end`},R=20,z=_({__name:`CatalogPage`,setup(u){let _=m(``),C=m(`popularity`),z=m([]),B=m(1),V=m([]),H=m(!1),U=m(!0),W=m(null),G=null,K=m(null),q=m(null);s(()=>{Y(),ye()});function ye(){G&&G.disconnect(),G=new IntersectionObserver(e=>{let t=e[0];t&&t.isIntersecting&&U.value&&!H.value&&Se()},{root:null,rootMargin:`400px`,threshold:0}),W.value&&G.observe(W.value)}g(()=>{let e=new Set;return V.value.forEach(t=>t.genres?.forEach(t=>e.add(t.russian||t.name))),Array.from(e).sort()});let be=[{value:`anons`,label:`Анонсировано`},{value:`ongoing`,label:`Сейчас выходит`},{value:`released`,label:`Вышедшее`}],xe=[{value:`ranked`,label:`По рейтингу`},{value:`popularity`,label:`По популярности`},{value:`title`,label:`По алфавиту`},{value:`aired_on`,label:`По дате выхода`}];async function J(){H.value=!0;try{let e=C.value,t=z.value.length?[...new Set(z.value)]:[void 0],n=!!(z.value.length||(_.value||``).trim()),r=(t,n)=>ae({page:t,limit:R,search:_.value||void 0,status:n,order:e}).catch(()=>[]),i=[],a=new Set;if(n){for(let e of t){let t=1;for(;;){let n=await r(t,e);if(!Array.isArray(n)||n.length===0)break;for(let e of n){if(!e||a.has(e.id))continue;a.add(e.id),i.push(e)}if(n.length<R)break;t+=1}}U.value=!1}else{let e=await r(B.value,t[0]);for(let t of e){if(!t||a.has(t.id))continue;a.add(t.id),i.push(t)}U.value=Array.isArray(e)&&e.length===R}B.value===1&&(V.value=[]),V.value.push(...i.filter(Boolean))}catch(e){console.error(`fetchPage error`,e),U.value=!1}finally{H.value=!1}}function Y(){B.value=1,U.value=!0,V.value=[],J()}function Se(){!U.value||H.value||(B.value+=1,J())}let Ce=g(()=>{let e=(_.value||``).toLowerCase();return V.value.filter(t=>{let n=!e||(t.russian||``).toLowerCase().includes(e)||(t.name||``).toLowerCase().includes(e),r=!z.value.length||z.value.includes(t.status);return n&&r})}),X=g(()=>{let e=[...Ce.value];switch(C.value){case`ranked`:return e.sort((e,t)=>(t.score||0)-(e.score||0));case`aired_on`:return e.sort((e,t)=>(t.airedOn?.year||0)-(e.airedOn?.year||0));case`title`:return e.sort((e,t)=>(e.russian||e.name||``).localeCompare(t.russian||t.name||``));default:return e}});function we(){_.value=``,C.value=`popularity`,z.value=[],Y()}function Te(e){C.value=e,Z()}function Z(){Y()}let Ee=()=>{_.value=``,Y()};function Q(e,t){if(!t?.target?.open){q.value===e&&(q.value=null);return}q.value=e;let n=K.value;n&&n.querySelectorAll(`details.filter-section`).forEach(t=>{t.dataset.key!==e&&t.open&&(t.open=!1)})}e(_,(e,t)=>{e!==t&&De()});let $=null;function De(){$&&clearTimeout($),$=setTimeout(()=>Y(),400)}return(e,s)=>{let u=t(`font-awesome-icon`);return x(),b(y,null,[p(`div`,oe,[p(`div`,se,[s[13]||=p(`div`,{class:`hero`},[p(`h1`,{class:`title`},[p(`span`,null,`Каталог`),S(` Аниме`)]),p(`p`,{class:`subtitle`},`Откройте для себя тысячи аниме с возможностью продвинутой фильтрации и персонализированных рекомендаций`)],-1),p(`div`,ce,[p(`div`,le,[p(`div`,ue,[p(`div`,de,`Найдено: `+r(X.value.length)+` аниме`,1),p(`div`,fe,[s[6]||=p(`span`,null,`Сортировать по:`,-1),h(p(`select`,{"onUpdate:modelValue":s[0]||=e=>C.value=e,class:`select small`,onChange:Z},[...s[5]||=[p(`option`,{value:`popularity`},`Популярности`,-1),p(`option`,{value:`ranked`},`Оценке`,-1),p(`option`,{value:`aired_on`},`Году`,-1),p(`option`,{value:`title`},`Алфавиту`,-1)]],544),[[ne,C.value]])])]),p(`div`,{class:`filters`,ref_key:`filtersRoot`,ref:K},[p(`div`,pe,[s[7]||=p(`label`,{class:`label`},`Поиск:`,-1),p(`div`,me,[h(p(`input`,{"onUpdate:modelValue":s[1]||=e=>_.value=e,type:`text`,class:`input`,placeholder:`Название аниме...`,onKeyup:ee(Z,[`enter`])},null,544),[[ie,_.value,void 0,{trim:!0}]]),_.value?(x(),b(`button`,{key:0,class:`icon-btn clear`,onClick:Ee,title:`Очистить`},[d(u,{icon:`fa-solid fa-xmark`})])):l(``,!0),p(`button`,{class:`icon-btn`,onClick:Z,title:`Искать`},[d(u,{icon:`fa-solid fa-magnifying-glass`})])])]),p(`div`,he,[p(`details`,{class:`filter-section`,open:!1,"data-key":`status`,onToggle:s[3]||=e=>Q(`status`,e)},[s[8]||=p(`summary`,{class:`section-title`},`Статус`,-1),p(`div`,ge,[(x(),b(y,null,c(be,e=>p(`label`,{key:e.value,class:`check`},[h(p(`input`,{type:`checkbox`,value:e.value,"onUpdate:modelValue":s[2]||=e=>z.value=e,onChange:Z},null,40,_e),[[f,z.value]]),p(`span`,null,r(e.label),1)])),64))])],32),p(`details`,{class:`filter-section`,open:!1,"data-key":`sort`,onToggle:s[4]||=e=>Q(`sort`,e)},[s[9]||=p(`summary`,{class:`section-title`},`Сортировка`,-1),p(`div`,w,[(x(),b(y,null,c(xe,e=>p(`button`,{key:e.value,class:a([`sort-item`,{active:C.value===e.value}]),onClick:t=>Te(e.value)},r(e.label),11,T)),64))])],32),p(`div`,E,[p(`button`,{class:`reset`,onClick:we},[d(u,{icon:`fa-solid fa-rotate-left`}),s[10]||=p(`span`,null,`Сбросить фильтры`,-1)])])])],512),p(`div`,D,[(x(!0),b(y,null,c(X.value,e=>(x(),te(i(v),{key:e.id,to:`/animes/${e.id}`,class:`catalog-card`},{default:o(()=>[p(`div`,{class:`catalog-card__image`,style:n({backgroundImage:`url(${e.poster.originalUrl})`})},null,4),s[12]||=p(`div`,{class:`catalog-card__overlay`},null,-1),p(`div`,O,[e.status===`ongoing`?(x(),b(`div`,k,`ONGOING `)):e.status===`released`?(x(),b(`div`,A,` COMPLETED`)):l(``,!0)]),p(`div`,j,[p(`div`,{class:`catalog-card__title`,title:e.russian||e.name},r(e.russian||e.name),9,M),p(`div`,N,[p(`span`,P,[d(u,{icon:`fa-solid fa-star`}),S(` `+r(e.score||`—`),1)]),p(`span`,F,r(e.airedOn?.year||`—`),1)]),e.genres?.length?(x(),b(`div`,I,[(x(!0),b(y,null,c(e.genres.slice(0,3),e=>(x(),b(`span`,{key:e.id},r(e.russian||e.name),1))),128))])):l(``,!0),d(i(v),{to:`/watch/${e.id}`,class:`catalog-card__watch`},{default:o(()=>[d(u,{icon:`fa-solid fa-play`}),s[11]||=p(`span`,null,`Смотреть`,-1)]),_:1},8,[`to`])])]),_:2},1032,[`to`]))),128)),p(`div`,{ref_key:`sentinel`,ref:W,class:`sentinel`},null,512)]),H.value?(x(),b(`div`,L,`Загрузка...`)):!U.value&&V.value.length?(x(),b(`div`,ve,`Это всё`)):l(``,!0)])])])]),d(re)],64)}}},[[`__scopeId`,`data-v-7d6b30c0`]]);export{z as default};